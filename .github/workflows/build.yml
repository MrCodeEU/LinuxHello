name: Build and Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        go-version: ['1.21', '1.22']
        os: [ubuntu-latest]

    steps:
    - uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: ${{ matrix.go-version }}

    - name: Cache Go modules
      uses: actions/cache@v4
      with:
        path: ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libv4l-dev \
          libpam0g-dev \
          libsqlite3-dev \
          pkg-config

    - name: Download ONNX Runtime
      run: |
        # Download ONNX Runtime for CI
        wget -q https://github.com/microsoft/onnxruntime/releases/download/v1.16.3/onnxruntime-linux-x64-1.16.3.tgz
        tar -xzf onnxruntime-linux-x64-1.16.3.tgz
        sudo cp -r onnxruntime-linux-x64-1.16.3/include/* /usr/local/include/
        sudo cp -r onnxruntime-linux-x64-1.16.3/lib/* /usr/local/lib/
        sudo ldconfig

    - name: Download dependencies
      run: go mod download

    - name: Build binaries
      run: |
        go build -v ./cmd/facelock
        go build -v ./cmd/facelock-enroll
        go build -v ./cmd/facelock-test

    - name: Build PAM module
      run: |
        CGO_CFLAGS="-I/usr/include" \
        CGO_LDFLAGS="-lpam -lpam_misc" \
        go build -buildmode=c-shared -v ./pkg/pam

    - name: Run tests
      run: go test -v ./...

    - name: Run vet
      run: go vet ./...

    - name: Check formatting
      run: |
        if [ -n "$(gofmt -l .)" ]; then
          echo "Go code is not formatted:"
          gofmt -l .
          exit 1
        fi

  build-fedora:
    runs-on: ubuntu-latest
    container:
      image: fedora:latest

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        dnf install -y \
          golang \
          gcc \
          gcc-c++ \
          make \
          libv4l-devel \
          pam-devel \
          sqlite-devel \
          pkg-config \
          wget \
          tar

    - name: Download ONNX Runtime
      run: |
        wget -q https://github.com/microsoft/onnxruntime/releases/download/v1.16.3/onnxruntime-linux-x64-1.16.3.tgz
        tar -xzf onnxruntime-linux-x64-1.16.3.tgz
        cp -r onnxruntime-linux-x64-1.16.3/include/* /usr/local/include/
        cp -r onnxruntime-linux-x64-1.16.3/lib/* /usr/local/lib/
        ldconfig

    - name: Build
      run: |
        go build -v ./cmd/facelock
        go build -v ./cmd/facelock-enroll
        go build -v ./cmd/facelock-test

  build-arch:
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        pacman -Syu --noconfirm
        pacman -S --noconfirm \
          go \
          gcc \
          make \
          v4l-utils \
          pam \
          sqlite \
          pkg-config \
          wget \
          tar

    - name: Download ONNX Runtime
      run: |
        wget -q https://github.com/microsoft/onnxruntime/releases/download/v1.16.3/onnxruntime-linux-x64-1.16.3.tgz
        tar -xzf onnxruntime-linux-x64-1.16.3.tgz
        cp -r onnxruntime-linux-x64-1.16.3/include/* /usr/local/include/
        cp -r onnxruntime-linux-x64-1.16.3/lib/* /usr/local/lib/

    - name: Build
      run: |
        go build -v ./cmd/facelock
        go build -v ./cmd/facelock-enroll
        go build -v ./cmd/facelock-test

  lint:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.21'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libv4l-dev \
          libpam0g-dev \
          libsqlite3-dev \
          pkg-config

    - name: golangci-lint
      uses: golangci/golangci-lint-action@v4
      with:
        version: latest
        args: --timeout=5m

  release:
    needs: [build, build-fedora, build-arch]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')

    steps:
    - uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.21'

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libv4l-dev \
          libpam0g-dev \
          libsqlite3-dev \
          rpm \
          dpkg-dev

    - name: Download ONNX Runtime
      run: |
        wget -q https://github.com/microsoft/onnxruntime/releases/download/v1.16.3/onnxruntime-linux-x64-1.16.3.tgz
        tar -xzf onnxruntime-linux-x64-1.16.3.tgz
        sudo cp -r onnxruntime-linux-x64-1.16.3/include/* /usr/local/include/
        sudo cp -r onnxruntime-linux-x64-1.16.3/lib/* /usr/local/lib/
        sudo ldconfig

    - name: Build release binaries
      run: |
        # Linux AMD64
        GOOS=linux GOARCH=amd64 go build -ldflags="-s -w" -o dist/facelock-linux-amd64 ./cmd/facelock
        GOOS=linux GOARCH=amd64 go build -ldflags="-s -w" -o dist/facelock-enroll-linux-amd64 ./cmd/facelock-enroll
        GOOS=linux GOARCH=amd64 go build -ldflags="-s -w" -o dist/facelock-test-linux-amd64 ./cmd/facelock-test
        
        # PAM module (requires CGO, only build for host arch)
        CGO_CFLAGS="-I/usr/include" \
        CGO_LDFLAGS="-lpam -lpam_misc" \
        go build -buildmode=c-shared -ldflags="-s -w" -o dist/pam_facelock.so ./pkg/pam

    - name: Create release packages
      run: |
        mkdir -p dist/packages
        
        # Create tarball
        tar -czf dist/packages/facelock-${GITHUB_REF_NAME}-linux-amd64.tar.gz \
          -C dist facelock-linux-amd64 facelock-enroll-linux-amd64 facelock-test-linux-amd64 pam_facelock.so \
          -C ../ configs scripts README.md

    - name: Upload release assets
      uses: softprops/action-gh-release@v1
      with:
        files: dist/packages/*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
