name: Build and Test

on:
  push:
    branches: [main, develop]
    tags: ["v*"]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  ONNXRUNTIME_VERSION: "1.23.2"
  GO_VERSION_STABLE: "1.25"
  GO_VERSION_PREVIOUS: "1.24"

jobs:
  # Lint job runs first to fail fast on code quality issues
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION_STABLE }}

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libv4l-dev \
            libpam0g-dev \
            libsqlite3-dev \
            pkg-config

      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v6
        with:
          version: latest
          args: --timeout=5m

      - name: Check formatting
        run: |
          if [ -n "$(gofmt -l .)" ]; then
            echo "Go code is not formatted:"
            gofmt -d .
            exit 1
          fi

      - name: Run go vet
        run: go vet ./...

  # Debian build
  build-debian:
    name: Build (Debian)
    needs: lint
    runs-on: ubuntu-latest
    container:
      image: debian:latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install dependencies
        run: |
          apt-get update
          apt-get install -y \
            golang \
            gcc \
            g++ \
            make \
            libv4l-dev \
            libpam0g-dev \
            libsqlite3-dev \
            pkg-config \
            wget \
            ca-certificates

      - name: Download ONNX Runtime
        run: |
          wget -q "https://github.com/microsoft/onnxruntime/releases/download/v${ONNXRUNTIME_VERSION}/onnxruntime-linux-x64-${ONNXRUNTIME_VERSION}.tgz"
          tar -xzf "onnxruntime-linux-x64-${ONNXRUNTIME_VERSION}.tgz"
          cp -r "onnxruntime-linux-x64-${ONNXRUNTIME_VERSION}/include/"* /usr/local/include/
          cp -r "onnxruntime-linux-x64-${ONNXRUNTIME_VERSION}/lib/"* /usr/local/lib/
          ldconfig

      - name: Build
        run: |
          go build -v ./cmd/linuxhello
          go build -v ./cmd/linuxhello-enroll
          go build -v ./cmd/linuxhello-test

      - name: Run tests
        run: go test -v ./...

  # Fedora build for RPM-based distros
  build-fedora:
    name: Build (Fedora)
    needs: lint
    runs-on: ubuntu-latest
    container:
      image: fedora:latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install dependencies
        run: |
          dnf install -y \
            golang \
            gcc \
            gcc-c++ \
            make \
            libv4l-devel \
            pam-devel \
            sqlite-devel \
            pkg-config \
            wget \
            tar

      - name: Download ONNX Runtime
        run: |
          wget -q "https://github.com/microsoft/onnxruntime/releases/download/v${ONNXRUNTIME_VERSION}/onnxruntime-linux-x64-${ONNXRUNTIME_VERSION}.tgz"
          tar -xzf "onnxruntime-linux-x64-${ONNXRUNTIME_VERSION}.tgz"
          cp -r "onnxruntime-linux-x64-${ONNXRUNTIME_VERSION}/include/"* /usr/local/include/
          cp -r "onnxruntime-linux-x64-${ONNXRUNTIME_VERSION}/lib/"* /usr/local/lib/
          ldconfig

      - name: Build
        run: |
          go build -v ./cmd/linuxhello
          go build -v ./cmd/linuxhello-enroll
          go build -v ./cmd/linuxhello-test

  # Arch Linux build
  build-arch:
    name: Build (Arch Linux)
    needs: lint
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install dependencies
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm \
            go \
            gcc \
            make \
            v4l-utils \
            pam \
            sqlite \
            pkg-config \
            wget \
            tar

      - name: Download ONNX Runtime
        run: |
          wget -q "https://github.com/microsoft/onnxruntime/releases/download/v${ONNXRUNTIME_VERSION}/onnxruntime-linux-x64-${ONNXRUNTIME_VERSION}.tgz"
          tar -xzf "onnxruntime-linux-x64-${ONNXRUNTIME_VERSION}.tgz"
          cp -r "onnxruntime-linux-x64-${ONNXRUNTIME_VERSION}/include/"* /usr/local/include/
          cp -r "onnxruntime-linux-x64-${ONNXRUNTIME_VERSION}/lib/"* /usr/local/lib/

      - name: Build
        run: |
          go build -v ./cmd/linuxhello
          go build -v ./cmd/linuxhello-enroll
          go build -v ./cmd/linuxhello-test

  # Release job with proper packaging
  release:
    name: Build and Release Packages
    needs: [build-debian, build-fedora, build-arch]
    runs-on: ubuntu-latest
    if: (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')) || (github.event_name == 'workflow_dispatch' && startsWith(github.ref, 'refs/tags/'))
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0  # Full history for proper version detection

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION_STABLE }}
          cache: true

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: web-ui/package-lock.json

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libv4l-dev \
            libpam0g-dev \
            libsqlite3-dev \
            rpm \
            dpkg-dev \
            pkg-config

      - name: Download ONNX Runtime
        run: |
          wget -q "https://github.com/microsoft/onnxruntime/releases/download/v${ONNXRUNTIME_VERSION}/onnxruntime-linux-x64-${ONNXRUNTIME_VERSION}.tgz"
          tar -xzf "onnxruntime-linux-x64-${ONNXRUNTIME_VERSION}.tgz"
          sudo cp -r "onnxruntime-linux-x64-${ONNXRUNTIME_VERSION}/include/"* /usr/local/include/
          sudo cp -r "onnxruntime-linux-x64-${ONNXRUNTIME_VERSION}/lib/"* /usr/local/lib/
          sudo ldconfig

      - name: Build web frontend
        run: |
          cd web-ui
          npm ci --omit=dev
          npm run build
          cd ..

      - name: Build Go binaries
        run: |
          mkdir -p bin
          
          # Build main binaries
          export CGO_ENABLED=1
          go build -ldflags="-s -w" -o bin/linuxhello ./cmd/linuxhello
          go build -ldflags="-s -w" -o bin/linuxhello-enroll ./cmd/linuxhello-enroll
          go build -ldflags="-s -w" -o bin/linuxhello-test ./cmd/linuxhello-test
          go build -ldflags="-s -w" -o bin/linuxhello-gui ./cmd/linuxhello-gui
          
          # Build PAM module
          CGO_CFLAGS="-I/usr/include" \
          CGO_LDFLAGS="-lpam -lpam_misc" \
          go build -buildmode=c-shared -ldflags="-s -w" -o bin/pam_linuxhello.so ./pkg/pam

      - name: Build distribution packages
        run: |
          # Get version from tag
          VERSION=${GITHUB_REF_NAME#v}
          echo "Building packages for version: $VERSION"
          
          # Run packaging script
          ./packaging/build-packages.sh "$VERSION"

      - name: Create model download helper
        run: |
          mkdir -p dist/helpers
          cat > dist/helpers/download-models.sh << 'EOF'
          #!/bin/bash
          # LinuxHello Model Download Helper
          
          MODEL_DIR="/usr/share/linuxhello/models"
          TEMP_DIR="/tmp/linuxhello-models"
          
          echo "LinuxHello Model Download Helper"
          echo "==============================="
          echo ""
          
          # Check if running as root
          if [ "$(id -u)" != "0" ]; then
             echo "This script should be run as root to install models system-wide"
             echo "Run: sudo $0"
             exit 1
          fi
          
          mkdir -p "$MODEL_DIR" "$TEMP_DIR"
          cd "$TEMP_DIR"
          
          echo "Downloading ONNX models..."
          
          # Download face detection model
          if [ ! -f "$MODEL_DIR/scrfd_person_2.5g.onnx" ]; then
              echo "Downloading face detection model (scrfd_person_2.5g.onnx)..."
              wget -q --show-progress "https://github.com/deepinsight/insightface/releases/download/v0.7/scrfd_person_2.5g.onnx"
              mv scrfd_person_2.5g.onnx "$MODEL_DIR/"
          fi
          
          # Download face recognition model
          if [ ! -f "$MODEL_DIR/arcface_r50.onnx" ]; then
              echo "Downloading face recognition model (arcface_r50.onnx)..."
              wget -q --show-progress "https://github.com/deepinsight/insightface/releases/download/v0.7/arcface_r50.onnx"
              mv arcface_r50.onnx "$MODEL_DIR/"
          fi
          
          echo "Models installed successfully!"
          echo "You can now start LinuxHello services."
          EOF
          chmod +x dist/helpers/download-models.sh

      - name: Upload release assets
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/packages/*
            dist/helpers/download-models.sh
          generate_release_notes: true
          body: |
            ## LinuxHello Release ${{ github.ref_name }}
            
            ### Installation
            
            **For Fedora/RHEL/CentOS:**
            ```bash
            # Download and install RPM
            wget https://github.com/MrCodeEU/LinuxHello/releases/download/${{ github.ref_name }}/linuxhello-*-1.*.rpm
            sudo dnf install linuxhello-*.rpm
            
            # Download models
            sudo wget https://github.com/MrCodeEU/LinuxHello/releases/download/${{ github.ref_name }}/download-models.sh
            sudo chmod +x download-models.sh && sudo ./download-models.sh
            
            # Start services
            sudo systemctl enable --now linuxhello-inference linuxhello-gui
            
            # Access GUI at http://localhost:8080
            ```
            
            **For Debian/Ubuntu:**
            ```bash
            # Download and install DEB
            wget https://github.com/MrCodeEU/LinuxHello/releases/download/${{ github.ref_name }}/linuxhello_*_amd64.deb
            sudo apt install ./linuxhello_*.deb
            
            # Download models and start (same as above)
            ```
            
            **Generic Installation:**
            ```bash
            # Download tarball
            wget https://github.com/MrCodeEU/LinuxHello/releases/download/${{ github.ref_name }}/linuxhello-*-linux-*.tar.gz
            tar -xzf linuxhello-*.tar.gz
            cd linuxhello-generic
            sudo ./install.sh
            ```
            
            ### Usage
            1. Open http://localhost:8080 in your browser
            2. Go to "Enroll Face" tab and enroll your face
            3. Go to "System & PAM" tab and enable PAM for sudo
            4. Test with `sudo ls` - it should authenticate using your face!
            
            ### Features in this release
            - ðŸŽ¯ Authentication test page with visual debugging
            - ðŸ“¦ Proper RPM/DEB packaging for easy installation
            - ðŸ”§ Improved PAM integration for Fedora/RHEL
            - ðŸ–¥ï¸ Web-based management GUI
            - ðŸ” Comprehensive face authentication system
